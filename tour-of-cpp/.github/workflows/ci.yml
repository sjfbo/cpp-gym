name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  BUILD_TYPE: Debug

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: brew install ninja

    - name: Configure CMake
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DTOUR_ENABLE_SANITIZERS=OFF \
          -DTOUR_ENABLE_WARNINGS_AS_ERRORS=ON \
          -DTOUR_BUILD_TESTS=ON

    - name: Build
      run: cmake --build build

    - name: Test
      working-directory: build
      run: ctest --output-on-failure --parallel 4

  build-ubuntu-gcc:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build g++-13

    - name: Configure CMake
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_CXX_COMPILER=g++-13 \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DTOUR_ENABLE_SANITIZERS=OFF \
          -DTOUR_ENABLE_WARNINGS_AS_ERRORS=OFF \
          -DTOUR_BUILD_TESTS=ON

    - name: Build
      run: cmake --build build

    - name: Test
      working-directory: build
      run: ctest --output-on-failure --parallel 4

  build-ubuntu-clang:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build clang-17 libc++-17-dev libc++abi-17-dev

    - name: Configure CMake
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_CXX_COMPILER=clang++-17 \
          -DCMAKE_CXX_FLAGS="-stdlib=libc++" \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DTOUR_ENABLE_SANITIZERS=OFF \
          -DTOUR_ENABLE_WARNINGS_AS_ERRORS=OFF \
          -DTOUR_BUILD_TESTS=ON

    - name: Build
      run: cmake --build build

    - name: Test
      working-directory: build
      run: ctest --output-on-failure --parallel 4

  format-check:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install clang-format
      run: sudo apt-get install -y clang-format-17

    - name: Check formatting
      run: |
        find chapters projects -name "*.cpp" -o -name "*.h" | \
          xargs clang-format-17 --dry-run --Werror
